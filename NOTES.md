# üìù –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –Ω–æ—Ç–∞—Ç–∫–∏ (–Ω–µ –≤–∫–ª—é—á–∞—é—Ç—å—Å—è –≤ –¥–µ–ø–ª–æ–π)

## –©–æ –≤–∏–¥–∞–ª–µ–Ω–æ:
- ‚ùå GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –¥–µ–ø–ª–æ–π (.github/)
- ‚ùå –¢–µ—Å—Ç–æ–≤—ñ —Å–∫—Ä–∏–ø—Ç–∏ (test_*.py)
- ‚ùå –ú—ñ–≥—Ä–∞—Ü—ñ–π–Ω—ñ —Å–∫—Ä–∏–ø—Ç–∏ (migrate_*.py)
- ‚ùå –°—Ç–∞—Ä—ñ shell —Å–∫—Ä–∏–ø—Ç–∏ (start*.sh)
- ‚ùå –ó–∞—Å—Ç–∞—Ä—ñ–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è (DEPLOY.md, FIX_BASE_URL.md, etc)
- ‚ùå –õ–æ–≥–∏ —Ç–∞ –ª–æ–∫–∞–ª—å–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–∏—Ö

## –í–∞–∂–ª–∏–≤—ñ –∑–º—ñ–Ω–∏:

### 1. Persistent Storage –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
- –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–µ–ø–µ—Ä –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ `/data/static/schedules/`
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —ñ—Å–Ω—É—é—á–∏–π volume `prosvitlo_data`
- –§–∞–π–ª–∏ –ù–ï –∑–Ω–∏–∫–∞—é—Ç—å –ø—ñ—Å–ª—è –¥–µ–ø–ª–æ—é

### 2. Test Push –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ
- –î–æ–¥–∞–Ω–æ `notification_type="tokens"` –≤ API
- –¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ FCM —Ç–æ–∫–µ–Ω–∏
- –ù–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –≤—Å—ñ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º

### 3. –î–µ–ø–ª–æ–π —Ç—ñ–ª—å–∫–∏ –≤—Ä—É—á–Ω—É
```bash
fly deploy
```

## –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö —Ç–µ—Å—Ç–æ–≤–∏—Ö —Å–∫—Ä–∏–ø—Ç—ñ–≤ (–ù–ï –∫–æ–º—ñ—Ç–∏—Ç–∏):

–Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω —Ç–µ—Å—Ç–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç:
1. –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª –∑ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º `test_` (–≤–∂–µ –≤ .gitignore)
2. –ü—ñ—Å–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤–∏–¥–∞–ª—ñ—Ç—å –∞–±–æ –∑–∞–ª–∏—à—ñ—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
3. –ù—ñ–∫–æ–ª–∏ –Ω–µ –∫–æ–º—ñ—Ç—å—Ç–µ –≤ git

## Firebase serviceAccountKey.json
- –í .gitignore
- –ù–ï –∫–æ–º—ñ—Ç–∏—Ç–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
- –ù–∞ Fly.io –¥–æ–¥–∞–Ω–æ —è–∫ —Å–µ–∫—Ä–µ—Ç

## –ü—Ä–æ–±–ª–µ–º–∞ –∑ –≤—ñ–¥—Å—É—Ç–Ω—ñ–º–∏ push-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏ (4 —Å—ñ—á–Ω—è 2026)

### –í–∏—è–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞:
- **–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö —Å—Ç–≤–æ—Ä–µ–Ω–∞ 30 –≥—Ä—É–¥–Ω—è** (–∫–æ–ª–∏ —Å—Ç–≤–æ—Ä—é–≤–∞–≤—Å—è volume)
- –ó 18 —Ç–µ—Å—Ç—É–≤–∞–ª—å–Ω–∏–∫—ñ–≤ **—Ç—ñ–ª—å–∫–∏ 6 –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏ —Ç–æ–∫–µ–Ω–∏** (—Ç—ñ —Ö—Ç–æ –≤—ñ–¥–∫—Ä–∏–≤ –¥–æ–¥–∞—Ç–æ–∫ –ø—ñ—Å–ª—è 30 –≥—Ä—É–¥–Ω—è)
- –†–µ—à—Ç–∞ 12 –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ **–Ω–µ –æ—Ç—Ä–∏–º—É—é—Ç—å –ø—É—à—ñ**, –±–æ —ó—Ö —Ç–æ–∫–µ–Ω—ñ–≤ –Ω–µ–º–∞—î –≤ –±–∞–∑—ñ
- –î–æ–¥–∞—Ç–æ–∫ **–ù–ï –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î —Ç–æ–∫–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ**, —è–∫—â–æ –≤–≤–∞–∂–∞—î —â–æ –≤—ñ–Ω –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π

### –©–æ –±—É–ª–æ –∑—Ä–æ–±–ª–µ–Ω–æ:
1. ‚úÖ –î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω—É –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ Firebase (–≤–∏—è–≤–ª–µ–Ω–Ω—è –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤)
2. ‚úÖ –î–æ–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤ –∑ –±–∞–∑–∏
3. ‚úÖ –î–æ–¥–∞–Ω–æ –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—é —Ç–æ–∫–µ–Ω—ñ–≤ —É –≤—Å—ñ—Ö —Ñ—É–Ω–∫—Ü—ñ—è—Ö –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
4. ‚úÖ –î–æ–¥–∞–Ω–æ endpoint `GET /api/v1/tokens/{device_id}/exists` –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞
5. ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç–æ–∫–µ–Ω—ñ–≤ (–≤—ñ–¥—Ä—ñ–∑–Ω—è—î–º–æ "—Å—Ç–≤–æ—Ä–µ–Ω–æ" vs "–æ–Ω–æ–≤–ª–µ–Ω–æ")

### –©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ –¥–æ–¥–∞—Ç–∫–∞:

#### –í–∞—Ä—ñ–∞–Ω—Ç 1 (–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π): –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
```kotlin
// –ü—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –¥–æ–¥–∞—Ç–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ç–æ–∫–µ–Ω —ñ—Å–Ω—É—î –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
suspend fun checkAndRegisterToken() {
    val deviceId = getDeviceId()
    val response = api.checkTokenExists(deviceId)
    
    if (!response.exists) {
        // –¢–æ–∫–µ–Ω–∞ –Ω–µ–º–∞—î –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ - —Ä–µ—î—Å—Ç—Ä—É—î–º–æ
        val fcmToken = FirebaseMessaging.getInstance().token.await()
        api.registerToken(deviceId, fcmToken, platform)
    }
}
```

#### –í–∞—Ä—ñ–∞–Ω—Ç 2: –ü–µ—Ä—ñ–æ–¥–∏—á–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
```kotlin
// –í—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ —Ç–æ–∫–µ–Ω —Ä–∞–∑ –Ω–∞ –¥–æ–±—É –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ —á–∏ –≤—ñ–Ω –∑–º—ñ–Ω–∏–≤—Å—è
if (shouldRefreshToken()) { // –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ lastSync –¥–∞—Ç—É
    val fcmToken = FirebaseMessaging.getInstance().token.await()
    api.registerToken(deviceId, fcmToken, platform)
}
```

#### –í–∞—Ä—ñ–∞–Ω—Ç 3: –ó–∞–≤–∂–¥–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏
```kotlin
// –ü—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É –¥–æ–¥–∞—Ç–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ —Ç–æ–∫–µ–Ω (–Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–µ)
// –°–µ—Ä–≤–µ—Ä —Å–∞–º –≤–∏–∑–Ω–∞—á–∏—Ç—å —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏
val fcmToken = FirebaseMessaging.getInstance().token.await()
api.registerToken(deviceId, fcmToken, platform)
```

### –¢–∏–º—á–∞—Å–æ–≤–µ —Ä—ñ—à–µ–Ω–Ω—è –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–ª—å–Ω–∏–∫—ñ–≤:
–ü–æ–ø—Ä–æ—Å–∏—Ç–∏ –≤—Å—ñ—Ö —Ç–µ—Å—Ç—É–≤–∞–ª—å–Ω–∏–∫—ñ–≤ **–ø–µ—Ä–µ–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫** –∞–±–æ **–æ—á–∏—Å—Ç–∏—Ç–∏ –¥–∞–Ω—ñ –¥–æ–¥–∞—Ç–∫–∞** - —Ü–µ –∑–º—É—Å–∏—Ç—å –π–æ–≥–æ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω –∑–∞–Ω–æ–≤–æ.

### –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥:
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤
flyctl ssh console -a prosvitlo-backend
python -c "import sqlite3; conn = sqlite3.connect('/data/prosvitlo.db'); cursor = conn.cursor(); cursor.execute('SELECT COUNT(*) FROM device_tokens'); print(f'Tokens: {cursor.fetchone()[0]}'); conn.close()"

# –ü–æ–¥–∏–≤–∏—Ç–∏—Å—è –æ—Å—Ç–∞–Ω–Ω—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
flyctl logs -a prosvitlo-backend | grep "device token"
```
